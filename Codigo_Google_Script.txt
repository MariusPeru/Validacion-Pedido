// CÓDIGO GOOGLE APPS SCRIPT
// Copia todo el contenido de este archivo al editor de script de tu Google Sheet.

function doGet(e) {
  return HtmlService.createHtmlOutput("API activa. Usa POST para interactuar.");
}

function doPost(e) {
  const output = ContentService.createTextOutput();
  output.setMimeType(ContentService.MimeType.JSON);
  
  try {
    const payload = JSON.parse(e.postData.contents);
    const action = payload.action;
    let result = {};
    
    switch(action) {
      case 'login':
        result = login(payload.user, payload.pass);
        break;
      case 'listarPedidos':
        result = listarPedidos();
        break;
      case 'crearPedido':
        result = crearPedido(payload);
        break;
      case 'validarPedido':
        result = validarPedido(payload);
        break;
      case 'rechazarPedido':
        result = rechazarPedido(payload);
        break;
      case 'crearPedidosMasivos':
        result = crearPedidosMasivos(payload);
        break;
      default:
        result = { success: false, message: "Acción desconocida: " + action + " (Versión antigua)" };
    }
    
    output.setContent(JSON.stringify(result));
  } catch (err) {
    output.setContent(JSON.stringify({ success: false, message: err.toString() }));
  }
  
  return output;
}

function getSheet() {
  return SpreadsheetApp.getActiveSpreadsheet();
}

function login(user, pass) {
  const sheet = getSheet().getSheetByName('Usuarios');
  if (!sheet) return { success: false, message: "Hoja 'Usuarios' no encontrada" };
  
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][0]) == user && String(data[i][1]) == pass) {
      return { 
        success: true, 
        user: { 
          usuario: data[i][0], 
          nombre: data[i][2],
          rol: data[i][3] || 'Lector'
        } 
      };
    }
  }
  return { success: false, message: "Credenciales incorrectas" };
}

function getUserRole(username) {
  const sheet = getSheet().getSheetByName('Usuarios');
  if (!sheet) return 'Lector';
  const data = sheet.getDataRange().getValues();
  for(let i=1; i<data.length; i++) {
    if(String(data[i][0]) == username) {
      return data[i][3] || 'Lector';
    }
  }
  return 'Lector';
}

function listarPedidos() {
  const sheet = getSheet().getSheetByName('Pedidos');
  if (!sheet) return { success: false, message: "Hoja 'Pedidos' no encontrada" };
  
  const data = sheet.getDataRange().getValues();
  const pedidos = [];

  for (let i = 1; i < data.length; i++) {
    const row = data[i];
    if (!row[0]) continue; 

    pedidos.push({
      nro: row[0],
      fecha: row[1],
      llave: row[2],
      monto: row[3],
      foto: row[4],
      monto_foto: row[5],
      estado: row[6],
      validado_por: row[7],
      fecha_validacion: row[8]
    });
  }
  
  pedidos.sort((a, b) => b.nro - a.nro);
  return { success: true, data: pedidos };
}

function crearPedido(data) {
  if (getUserRole(data.usuario) !== 'Admin') return { success: false, message: "Acceso Denegado: Se requiere rol Admin" };

  const sheet = getSheet().getSheetByName('Pedidos');
  const allData = sheet.getDataRange().getValues();
  const newNro = parseInt(data.nro);
  
  let maxNro = 0;
  let exists = false;
  
  for(let i=1; i<allData.length; i++) {
    const n = parseInt(allData[i][0]);
    if (!isNaN(n)) {
      if(n > maxNro) maxNro = n;
      if(n == newNro) exists = true;
    }
  }
  
  if (exists) return { success: false, message: "El pedido ya existe" };
  
  // Date Logic
  let fecha;
  if(data.fecha) {
    const parts = data.fecha.split('-');
    fecha = new Date(parts[0], parts[1]-1, parts[2]); 
  } else {
    fecha = new Date();
  }
  
  if (maxNro > 0 && newNro > maxNro + 1) {
    for (let gap = maxNro + 1; gap < newNro; gap++) {
      sheet.appendRow([
        gap,
        new Date(),
        `RESERVADO-${gap}`,
        0, "", 0, "Reservado", "", ""
      ]);
    }
  }
  
  sheet.appendRow([
    newNro,
    fecha,
    data.llave,
    parseFloat(data.monto),
    "", 0, "Pendiente", "", ""
  ]);
  
  return { success: true };
}

function validarPedido(data) {
  if (getUserRole(data.usuario) !== 'Admin') return { success: false, message: "Acceso Denegado: Se requiere rol Admin" };

  const sheet = getSheet().getSheetByName('Pedidos');
  const allData = sheet.getDataRange().getValues();
  const targetNro = parseInt(data.nro);
  
  let rowIndex = -1;
  for(let i=1; i<allData.length; i++) {
    if(parseInt(allData[i][0]) == targetNro) {
      rowIndex = i + 1;
      break;
    }
  }
  
  if (rowIndex == -1) return { success: false, message: "Pedido no encontrado" };
  
  let fotoUrl = "";
  
  if (data.tipo === 'EFECTIVO') {
    fotoUrl = "PAGO-EFECTIVO";
  } else if (data.tipo === 'ONLINE') {
    fotoUrl = "PAGO-ONLINE";
  } else if (data.archivo) {
    try {
      const decoded = Utilities.base64Decode(data.archivo.data);
      const blob = Utilities.newBlob(decoded, data.archivo.type, `pedido_${targetNro}.jpg`);
      
      const folderName = "Fotos_Pedidos_Validacion";
      const folders = DriveApp.getFoldersByName(folderName);
      let folder;
      if (folders.hasNext()) { folder = folders.next(); }
      else { folder = DriveApp.createFolder(folderName); }
      
      const file = folder.createFile(blob);
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      fotoUrl = "https://lh3.googleusercontent.com/d/" + file.getId(); 
      
    } catch (e) {
      return { success: false, message: "Error subiendo foto: " + e.toString() };
    }
  } else {
    fotoUrl = allData[rowIndex-1][4]; 
  }
  
  const montoRegistrado = parseFloat(allData[rowIndex-1][3]);
  const montoFoto = parseFloat(data.montoFoto);
  let estado = "No Validado";
  
  if (Math.abs(montoRegistrado - montoFoto) < 0.5) {
    estado = "Validado";
  }
  
  const range = sheet.getRange(rowIndex, 5, 1, 5);
  range.setValues([[
    fotoUrl,
    montoFoto,
    estado,
    data.usuario,
    new Date()
  ]]);
  
  return { success: true };
}

function rechazarPedido(data) {
  if (getUserRole(data.usuario) !== 'Admin') return { success: false, message: "Acceso Denegado: Se requiere rol Admin" };

  const sheet = getSheet().getSheetByName('Pedidos');
  const allData = sheet.getDataRange().getValues();
  const targetNro = parseInt(data.nro);
  
  let rowIndex = -1;
  for(let i=1; i<allData.length; i++) {
    if(parseInt(allData[i][0]) == targetNro) {
      rowIndex = i + 1;
      break;
    }
  }
  
  if (rowIndex == -1) return { success: false, message: "Pedido no encontrado" };
  
  // Col 7: Estado (index 6), Col 8: Validado Por, Col 9: Fecha
  sheet.getRange(rowIndex, 7, 1, 3).setValues([[
    "Rechazado",
    data.usuario,
    new Date()
  ]]);
  
  return { success: true };
}

function crearPedidosMasivos(payload) {
  // 1. Check Permissions
  if (getUserRole(payload.usuario) !== 'Admin') {
     return { success: false, message: "Acceso Denegado: Se requiere rol Admin" };
  }

  const sheet = getSheet().getSheetByName('Pedidos');
  const data = sheet.getDataRange().getValues();
  
  // 2. Analyze existing data (Max Nro and Existing Keys)
  let maxNro = 0;
  const existingKeys = new Set();
  
  for(let i=1; i<data.length; i++) {
    const rowNro = parseInt(data[i][0]);
    if (!isNaN(rowNro) && rowNro > maxNro) maxNro = rowNro;
    
    if(data[i][2]) existingKeys.add(String(data[i][2]).trim());
  }
  
  // 3. Process New Orders
  const newOrders = payload.orders; // Array of { llave, fecha, monto }
  let addedCount = 0;
  let skippedCount = 0;
  
  // Month Map for parsing text dates like "18 feb. 2026"
  const monthMap = {
     'ene': 0, 'feb': 1, 'mar': 2, 'abr': 3, 'may': 4, 'jun': 5,
     'jul': 6, 'ago': 7, 'sep': 8, 'oct': 9, 'nov': 10, 'dic': 11
  };
  
  newOrders.forEach(order => {
      // Skip if key exists
      if(existingKeys.has(String(order.llave).trim())) {
          skippedCount++;
          return;
      }
      
      maxNro++;
      
      // Parse Date (Expects string "DD MMM. YYYY" or ISO)
      // If regex failed in frontend, it might be current date.
      let orderDate = new Date();
      try {
         if(order.fecha && typeof order.fecha === 'string' && order.fecha.includes(' ')) {
             // Try manual parse "18 feb. 2026"
             const parts = order.fecha.toLowerCase().replace('.','').split(' ');
             // parts[0] = day, parts[1] = monthname, parts[2] = year
             // Check if parts[1] is in map
             if(monthMap[parts[1]] !== undefined) {
                 orderDate = new Date(parseInt(parts[2]), monthMap[parts[1]], parseInt(parts[0]));
             } else {
                 orderDate = new Date(order.fecha); // Try standard parse
             }
         } else if (order.fecha) {
             orderDate = new Date(order.fecha);
         }
      } catch(e) {
         orderDate = new Date();
      }
      
      sheet.appendRow([
        maxNro,
        orderDate,
        order.llave,
        parseFloat(order.monto),
        "", 0, "Pendiente", "", ""
      ]);
      
      addedCount++;
  });
  
  return { success: true, added: addedCount, skipped: skippedCount, message: `Importado: ${addedCount}, Duplicados: ${skippedCount}` };
}
