// --- CÓDIGO GOOGLE APPS SCRIPT FINAL ---
// Copia todo este contenido a tu editor de scripts de Google (Código.gs)

function doGet(e) {
  return HtmlService.createHtmlOutput("API Activa - Versión Final Corregida");
}

function doPost(e) {
  const output = ContentService.createTextOutput().setMimeType(ContentService.MimeType.JSON);
  try {
    const payload = JSON.parse(e.postData.contents);
    const action = payload.action;
    let result = {};
    
    switch(action) {
      case 'login': result = login(payload.user, payload.pass); break;
      case 'listarPedidos': result = listarPedidos(); break;
      case 'crearPedido': result = crearPedido(payload); break;
      case 'validarPedido': result = validarPedido(payload); break;
      case 'rechazarPedido': result = rechazarPedido(payload); break;
      case 'crearPedidosMasivos': result = crearPedidosMasivos(payload); break;
      default: result = { success: false, message: "Acción desconocida" };
    }
    output.setContent(JSON.stringify(result));
  } catch (err) {
    output.setContent(JSON.stringify({ success: false, message: err.toString() }));
  }
  return output;
}

function getSheet() { return SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Pedidos'); }

function login(user, pass) {
  const sheet = SpreadsheetApp.getActiveSpreadsheet().getSheetByName('Usuarios');
  if (!sheet) return { success: false, message: "Hoja 'Usuarios' no encontrada" };
  const data = sheet.getDataRange().getValues();
  for (let i = 1; i < data.length; i++) {
    if (String(data[i][0]) == user && String(data[i][1]) == pass) {
      return { success: true, user: { usuario: data[i][0], nombre: data[i][2], rol: data[i][3] || 'Lector' } };
    }
  }
  return { success: false, message: "Credenciales incorrectas" };
}

function listarPedidos() {
  const sheet = getSheet();
  if (!sheet) return { success: false, message: "Hoja 'Pedidos' no encontrada" };
  const lastRow = sheet.getLastRow();
  if (lastRow < 2) return { success: true, data: [] };
  const data = sheet.getRange(2, 1, lastRow - 1, 10).getValues();
  const pedidos = data.map(row => ({
    nro: row[0], fecha: row[1], llave: row[2], monto: row[3], foto: row[4],
    monto_foto: row[5], estado: row[6], validado_por: row[7], fecha_validacion: row[8], envio: row[9]
  })).filter(p => p.nro);
  return { success: true, data: pedidos.sort((a, b) => b.nro - a.nro) };
}

function validarPedido(data) {
  var sheet = getSheet();
  var rows = sheet.getDataRange().getValues();
  var rowIndex = -1;
  for (var i = 1; i < rows.length; i++) { if (rows[i][0] == data.nro) { rowIndex = i + 1; break; } }
  if (rowIndex === -1) return { success: false, message: "No encontrado" };
  
  var photoUrl = "";
  if (data.archivo && data.archivo.data) {
    try {
      // TU ID DE CARPETA YA CONFIGURADO
      var folderId = "1YO8veJ9RtTGOBdilEEnVHdPSLwsbGdRo"; 
      var folder = (folderId && folderId.length > 10) ? DriveApp.getFolderById(folderId) : DriveApp.getRootFolder();
      var blob = Utilities.newBlob(Utilities.base64Decode(data.archivo.data), data.archivo.type, data.archivo.name);
      var file = folder.createFile(blob);
      file.setSharing(DriveApp.Access.ANYONE_WITH_LINK, DriveApp.Permission.VIEW);
      photoUrl = "https://lh3.googleusercontent.com/d/" + file.getId(); // Link Directo
    } catch(e) { photoUrl = "Error Foto: " + e.toString(); }
  } else {
    var current = rows[rowIndex-1][4] || "";
    photoUrl = current.split(" ")[0]; // Mantener URL base si ya existía
  }

  // INYECCIÓN DE DATOS: URL + TIPO + VUELTO
  var injectedValue = photoUrl || "";
  if (data.tipo) injectedValue += " " + data.tipo;
  if (data.tipo === "EFECTIVO" && data.vuelto) injectedValue += " VUELTO: " + data.vuelto;
  
  // Guardar en Columnas E, F, G, H, I (Índices 5, 6, 7, 8, 9)
  sheet.getRange(rowIndex, 5).setValue(injectedValue.trim()); // Foto/Inyectado
  sheet.getRange(rowIndex, 6).setValue(data.montoFoto); // Monto OCR
  sheet.getRange(rowIndex, 7).setValue("Validado"); 
  sheet.getRange(rowIndex, 8).setValue(data.usuario);
  sheet.getRange(rowIndex, 9).setValue(new Date()); 
  return { success: true };
}

function crearPedidosMasivos(payload) {
  const sheet = getSheet();
  const data = sheet.getDataRange().getValues();
  let maxNro = 0;
  const existingKeys = new Set();
  for(let i=1; i<data.length; i++) {
    const currentNro = parseInt(data[i][0]);
    if (currentNro > maxNro) maxNro = currentNro;
    if (data[i][2]) existingKeys.add(String(data[i][2]).trim());
  }
  
  payload.orders.forEach(order => {
    if(existingKeys.has(String(order.llave).trim())) return;
    maxNro++;
    // Columna J (10) para Responsable Envío
    sheet.appendRow([maxNro, order.fecha, order.llave, parseFloat(order.monto), "", 0, "Pendiente", "", "", order.envio || ""]);
  });
  return { success: true };
}

function crearPedido(data) {
  const sheet = getSheet();
  sheet.appendRow([data.nro, new Date(), data.llave, data.monto, "", 0, "Pendiente", "", "", data.envio || ""]);
  return { success: true };
}

function rechazarPedido(data) {
  const sheet = getSheet();
  const rows = sheet.getDataRange().getValues();
  for (let i = 1; i < rows.length; i++) {
    if (rows[i][0] == data.nro) {
      sheet.getRange(i + 1, 7).setValue("Cancelado");
      sheet.getRange(i + 1, 8).setValue(data.usuario);
      sheet.getRange(i + 1, 9).setValue(new Date());
      return { success: true };
    }
  }
  return { success: false };
}
